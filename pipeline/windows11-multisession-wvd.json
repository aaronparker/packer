{
    "options": [
        {
            "enabled": false,
            "definition": {
                "id": "5d58cc01-7c75-450c-be18-a388ddb129ec"
            },
            "inputs": {
                "branchFilters": "[\"+refs/heads/*\"]",
                "additionalFields": "{}"
            }
        },
        {
            "enabled": false,
            "definition": {
                "id": "a9db38f9-9fdc-478c-b0f9-464221e58316"
            },
            "inputs": {
                "workItemType": "Issue",
                "assignToRequestor": "true",
                "additionalFields": "{}"
            }
        }
    ],
    "variables": {
        "system.debug": {
            "value": "false",
            "allowOverride": true
        }
    },
    "variableGroups": [
        {
            "variables": {
                "build_key_vault": {
                    "value": "stpyimageaustraliaeast"
                },
                "build_resource_group": {
                    "value": "rg-ImageBuild-AustraliaEast"
                },
                "build_source_repo": {
                    "value": "$(Build.Repository.Uri)"
                },
                "build_subnet": {
                    "value": "subnet-Packer"
                },
                "build_vnet": {
                    "value": "vnet-ImageBuild-AustraliaEast"
                },
                "created_date": {
                    "value": "$(Build.BuildNumber)"
                },
                "destination_gallery_name": {
                    "value": "sigWindowsVirtualDesktop"
                },
                "destination_gallery_resource_group": {
                    "value": "rg-Images-AustraliaEast"
                },
                "destination_image_version": {
                    "value": "1.0.$(Build.BuildId)"
                },
                "destination_replication_regions": {
                    "value": "australiaeast"
                },
                "managed_image_resource_group_name": {
                    "value": "rg-Images-AustraliaEast"
                },
                "owner": {
                    "value": "AzureDevOps"
                },
                "vm_size": {
                    "value": "Standard_D2as_v4"
                }
            },
            "type": "Vsts",
            "name": "WindowsVirtualDesktop-enAU",
            "description": "Common variables for all WVD images",
            "id": 3
        },
        {
            "variables": {
                "GitHubKey": {
                    "value": null,
                    "isSecret": true
                },
                "GitHubUserEmail": {
                    "value": "aaron@stealthpuppy.com"
                },
                "GitHubUserName": {
                    "value": "Aaron Parker"
                }
            },
            "type": "Vsts",
            "name": "GitHub",
            "description": "Variables for pushing commits to GitHub repos",
            "id": 4
        },
        {
            "variables": {
                "apps_url": {
                    "value": "https://stpyimgbuildaue.blob.core.windows.net/apps"
                },
                "image_offer": {
                    "value": "Windows-11"
                },
                "image_publisher": {
                    "value": "MicrosoftWindowsDesktop"
                },
                "image_sku": {
                    "value": "win11-21h2-avd"
                },
                "packages_url": {
                    "value": "https://stpyimgbuildaue.blob.core.windows.net/packages"
                }
            },
            "type": "Vsts",
            "name": "Windows11MultiSession-enAU",
            "description": "Variables for Windows 11 multi-session with en-AU",
            "id": 8
        }
    ],
    "properties": {},
    "tags": [],
    "_links": {
        "self": {
            "href": "https://dev.azure.com/stealthpuppyLab/43bf99ab-7b12-4015-9e5b-30c20cd7cd60/_apis/build/Definitions/9?revision=1"
        },
        "web": {
            "href": "https://dev.azure.com/stealthpuppyLab/43bf99ab-7b12-4015-9e5b-30c20cd7cd60/_build/definition?definitionId=9"
        },
        "editor": {
            "href": "https://dev.azure.com/stealthpuppyLab/43bf99ab-7b12-4015-9e5b-30c20cd7cd60/_build/designer?id=9&_a=edit-build-definition"
        },
        "badge": {
            "href": "https://dev.azure.com/stealthpuppyLab/43bf99ab-7b12-4015-9e5b-30c20cd7cd60/_apis/build/status/9"
        }
    },
    "buildNumberFormat": "$(Date:yyyyMMdd).$(Rev:rr)",
    "description": "Builds a Windows 10 multi-session image for use with Windows Virtual Desktop",
    "jobAuthorizationScope": 1,
    "jobTimeoutInMinutes": 120,
    "jobCancelTimeoutInMinutes": 5,
    "badgeEnabled": true,
    "process": {
        "phases": [
            {
                "steps": [
                    {
                        "environment": {},
                        "enabled": true,
                        "continueOnError": false,
                        "alwaysRun": false,
                        "displayName": "Install Packer",
                        "timeoutInMinutes": 0,
                        "retryCountOnTaskFailure": 0,
                        "condition": "succeeded()",
                        "task": {
                            "id": "b6ddafd8-587a-4e47-94f7-3102ed47dad8",
                            "versionSpec": "0.*",
                            "definitionType": "task"
                        },
                        "inputs": {
                            "version": ""
                        }
                    },
                    {
                        "environment": {},
                        "enabled": true,
                        "continueOnError": false,
                        "alwaysRun": false,
                        "displayName": "Download Packer plugins",
                        "timeoutInMinutes": 0,
                        "retryCountOnTaskFailure": 0,
                        "condition": "succeeded()",
                        "task": {
                            "id": "e213ff0f-5d5c-4791-802d-52ea3e7be1f1",
                            "versionSpec": "2.*",
                            "definitionType": "task"
                        },
                        "inputs": {
                            "targetType": "filePath",
                            "filePath": "pipeline/Get-PackerPlugins.ps1",
                            "arguments": "",
                            "script": "",
                            "errorActionPreference": "stop",
                            "warningPreference": "default",
                            "informationPreference": "default",
                            "verbosePreference": "default",
                            "debugPreference": "default",
                            "failOnStderr": "false",
                            "showWarnings": "false",
                            "ignoreLASTEXITCODE": "false",
                            "pwsh": "false",
                            "workingDirectory": "",
                            "runScriptInSeparateScope": "false"
                        }
                    },
                    {
                        "environment": {},
                        "enabled": true,
                        "continueOnError": false,
                        "alwaysRun": false,
                        "displayName": "Packer validate",
                        "timeoutInMinutes": 0,
                        "retryCountOnTaskFailure": 0,
                        "condition": "succeeded()",
                        "refName": "packerValidate",
                        "task": {
                            "id": "b3c6bb07-1292-44e7-9ec9-b211fc98b6d2",
                            "versionSpec": "1.*",
                            "definitionType": "task"
                        },
                        "inputs": {
                            "connectedServiceType": "azure",
                            "connectedServiceAzure": "ef1deb8d-e2cc-46bb-9cc8-5dc5551d9594",
                            "connectedServiceAWS": "",
                            "templatePath": "templates/rds/PackerTemplate-WindowsAzure.json",
                            "command": "validate",
                            "force": "false",
                            "variables": "image_publisher=$(image_publisher)\nimage_offer=$(image_offer)\nimage_sku=$(image_sku)\nimage_date=$(Build.BuildNumber)\nmanaged_image_resource_group_name=$(managed_image_resource_group_name)\nvm_size=$(vm_size)\ntag_owner=$(owner)\ntag_created_date=$(Build.BuildNumber)\napps_url=$(apps_url)\npackages_url=$(packages_url)\nbuild_key_vault=$(build_key_vault)\nbuild_resource_group=$(build_resource_group)\nbuild_vnet=$(build_vnet)\nbuild_subnet=$(build_subnet)\nbuild_source_repo=$(build_source_repo)\ndestination_gallery_resource_group=$(destination_gallery_resource_group)\ndestination_gallery_name=$(destination_gallery_name)\ndestination_image_version=1.0.$(Build.BuildId)\ndestination_replication_regions=$(destination_replication_regions)",
                            "variables-file": "",
                            "options": ""
                        }
                    },
                    {
                        "environment": {},
                        "enabled": true,
                        "continueOnError": false,
                        "alwaysRun": false,
                        "displayName": "Packer build",
                        "timeoutInMinutes": 0,
                        "retryCountOnTaskFailure": 0,
                        "condition": "succeeded()",
                        "refName": "packerBuild",
                        "task": {
                            "id": "b3c6bb07-1292-44e7-9ec9-b211fc98b6d2",
                            "versionSpec": "1.*",
                            "definitionType": "task"
                        },
                        "inputs": {
                            "connectedServiceType": "azure",
                            "connectedServiceAzure": "ef1deb8d-e2cc-46bb-9cc8-5dc5551d9594",
                            "connectedServiceAWS": "",
                            "templatePath": "templates/rds/PackerTemplate-WindowsAzure.json",
                            "command": "build",
                            "force": "true",
                            "variables": "image_publisher=$(image_publisher)\nimage_offer=$(image_offer)\nimage_sku=$(image_sku)\nimage_date=$(Build.BuildNumber)\nmanaged_image_resource_group_name=$(managed_image_resource_group_name)\nvm_size=$(vm_size)\ntag_owner=$(owner)\ntag_created_date=$(Build.BuildNumber)\napps_url=$(apps_url)\npackages_url=$(packages_url)\nbuild_key_vault=$(build_key_vault)\nbuild_resource_group=$(build_resource_group)\nbuild_vnet=$(build_vnet)\nbuild_subnet=$(build_subnet)\nbuild_source_repo=$(build_source_repo)\ndestination_gallery_resource_group=$(destination_gallery_resource_group)\ndestination_gallery_name=$(destination_gallery_name)\ndestination_image_version=1.0.$(Build.BuildId)\ndestination_replication_regions=$(destination_replication_regions)",
                            "variables-file": "",
                            "options": ""
                        }
                    },
                    {
                        "environment": {},
                        "enabled": true,
                        "continueOnError": false,
                        "alwaysRun": false,
                        "displayName": "Expand report archive",
                        "timeoutInMinutes": 0,
                        "retryCountOnTaskFailure": 0,
                        "condition": "succeeded()",
                        "task": {
                            "id": "e213ff0f-5d5c-4791-802d-52ea3e7be1f1",
                            "versionSpec": "2.*",
                            "definitionType": "task"
                        },
                        "inputs": {
                            "targetType": "filePath",
                            "filePath": "pipeline/Expand-ReportFiles.ps1",
                            "arguments": "-Verbose",
                            "script": "# Write your PowerShell commands here.\n\nWrite-Host \"Hello World\"\n",
                            "errorActionPreference": "stop",
                            "warningPreference": "default",
                            "informationPreference": "default",
                            "verbosePreference": "default",
                            "debugPreference": "default",
                            "failOnStderr": "false",
                            "showWarnings": "false",
                            "ignoreLASTEXITCODE": "false",
                            "pwsh": "false",
                            "workingDirectory": "",
                            "runScriptInSeparateScope": "false"
                        }
                    },
                    {
                        "environment": {},
                        "enabled": true,
                        "continueOnError": false,
                        "alwaysRun": false,
                        "displayName": "Publish Artifact: image-details",
                        "timeoutInMinutes": 0,
                        "retryCountOnTaskFailure": 0,
                        "condition": "succeeded()",
                        "task": {
                            "id": "2ff763a7-ce83-4e1f-bc89-0ae63477cebe",
                            "versionSpec": "1.*",
                            "definitionType": "task"
                        },
                        "inputs": {
                            "PathtoPublish": "$(System.DefaultWorkingDirectory)\\reports",
                            "ArtifactName": "image-details",
                            "ArtifactType": "Container",
                            "TargetPath": "",
                            "Parallel": "false",
                            "ParallelCount": "8",
                            "FileCopyOptions": "",
                            "StoreAsTar": "false"
                        }
                    },
                    {
                        "environment": {},
                        "enabled": true,
                        "continueOnError": false,
                        "alwaysRun": false,
                        "displayName": "Install required modules",
                        "timeoutInMinutes": 0,
                        "retryCountOnTaskFailure": 0,
                        "condition": "succeeded()",
                        "task": {
                            "id": "e213ff0f-5d5c-4791-802d-52ea3e7be1f1",
                            "versionSpec": "2.*",
                            "definitionType": "task"
                        },
                        "inputs": {
                            "targetType": "filePath",
                            "filePath": "pipeline/Install-RequiredModules.ps1",
                            "arguments": "-Verbose",
                            "script": "# Write your PowerShell commands here.\n\nWrite-Host \"Hello World\"\n",
                            "errorActionPreference": "stop",
                            "warningPreference": "default",
                            "informationPreference": "default",
                            "verbosePreference": "default",
                            "debugPreference": "default",
                            "failOnStderr": "false",
                            "showWarnings": "false",
                            "ignoreLASTEXITCODE": "false",
                            "pwsh": "false",
                            "workingDirectory": "",
                            "runScriptInSeparateScope": "false"
                        }
                    },
                    {
                        "environment": {},
                        "enabled": true,
                        "continueOnError": false,
                        "alwaysRun": false,
                        "displayName": "Publish report markdown",
                        "timeoutInMinutes": 0,
                        "retryCountOnTaskFailure": 0,
                        "condition": "succeeded()",
                        "task": {
                            "id": "e213ff0f-5d5c-4791-802d-52ea3e7be1f1",
                            "versionSpec": "2.*",
                            "definitionType": "task"
                        },
                        "inputs": {
                            "targetType": "filePath",
                            "filePath": "pipeline/Publish-MarkdownReport.ps1",
                            "arguments": "-Verbose",
                            "script": "# Write your PowerShell commands here.\n\nWrite-Host \"Hello World\"\n",
                            "errorActionPreference": "stop",
                            "warningPreference": "default",
                            "informationPreference": "default",
                            "verbosePreference": "default",
                            "debugPreference": "default",
                            "failOnStderr": "false",
                            "showWarnings": "false",
                            "ignoreLASTEXITCODE": "false",
                            "pwsh": "false",
                            "workingDirectory": "",
                            "runScriptInSeparateScope": "false"
                        }
                    },
                    {
                        "environment": {},
                        "enabled": true,
                        "continueOnError": false,
                        "alwaysRun": false,
                        "displayName": "Commit changes",
                        "timeoutInMinutes": 0,
                        "retryCountOnTaskFailure": 0,
                        "condition": "succeeded()",
                        "task": {
                            "id": "e213ff0f-5d5c-4791-802d-52ea3e7be1f1",
                            "versionSpec": "2.*",
                            "definitionType": "task"
                        },
                        "inputs": {
                            "targetType": "filePath",
                            "filePath": "pipeline/Push-Git.ps1",
                            "arguments": "$(GitHubKey)",
                            "script": "# Write your PowerShell commands here.\n\nWrite-Host \"Hello World\"\n",
                            "errorActionPreference": "stop",
                            "warningPreference": "default",
                            "informationPreference": "default",
                            "verbosePreference": "default",
                            "debugPreference": "default",
                            "failOnStderr": "false",
                            "showWarnings": "false",
                            "ignoreLASTEXITCODE": "false",
                            "pwsh": "false",
                            "workingDirectory": "",
                            "runScriptInSeparateScope": "false"
                        }
                    }
                ],
                "name": "Packer build",
                "refName": "Job_1",
                "condition": "succeeded()",
                "target": {
                    "executionOptions": {
                        "type": 0
                    },
                    "allowScriptsAuthAccessOption": false,
                    "type": 1
                },
                "jobAuthorizationScope": 1
            }
        ],
        "target": {
            "agentSpecification": {
                "identifier": "windows-latest"
            }
        },
        "type": 1
    },
    "repository": {
        "properties": {
            "apiUrl": "https://api.github.com/repos/aaronparker/packer",
            "branchesUrl": "https://api.github.com/repos/aaronparker/packer/branches",
            "cloneUrl": "https://github.com/aaronparker/packer.git",
            "connectedServiceId": "4aae32e8-d0ec-47b6-bede-cf08359e8558",
            "defaultBranch": "main",
            "fullName": "aaronparker/packer",
            "hasAdminPermissions": "False",
            "isFork": "False",
            "isPrivate": "False",
            "lastUpdated": "06/06/2021 04:03:42",
            "manageUrl": "https://github.com/aaronparker/packer",
            "nodeId": "MDEwOlJlcG9zaXRvcnkzMzM5NzAwNTU=",
            "ownerId": "8227455",
            "orgName": "aaronparker",
            "refsUrl": "https://api.github.com/repos/aaronparker/packer/git/refs",
            "safeRepository": "aaronparker/packer",
            "shortName": "packer",
            "ownerAvatarUrl": "https://avatars.githubusercontent.com/u/8227455?v=4",
            "archived": "False",
            "externalId": "333970055",
            "ownerIsAUser": "True",
            "checkoutNestedSubmodules": "true",
            "cleanOptions": "3",
            "fetchDepth": "0",
            "gitLfsSupport": "false",
            "reportBuildStatus": "true",
            "skipSyncSource": "false",
            "labelSourcesFormat": "$(build.buildNumber)",
            "labelSources": "0"
        },
        "id": "aaronparker/packer",
        "type": "GitHub",
        "name": "aaronparker/packer",
        "url": "https://github.com/aaronparker/packer.git",
        "defaultBranch": "main",
        "clean": "true",
        "checkoutSubmodules": true
    },
    "processParameters": {},
    "quality": 1,
    "authoredBy": {
        "displayName": "Aaron Parker",
        "url": "https://spsprodeau1.vssps.visualstudio.com/Afe5a66c8-5c58-43c1-8c09-5789f14c3847/_apis/Identities/60a4ce03-deda-6df1-9ca1-f242bcd7cda0",
        "_links": {
            "avatar": {
                "href": "https://dev.azure.com/stealthpuppyLab/_apis/GraphProfile/MemberAvatars/aad.NjBhNGNlMDMtZGVkYS03ZGYxLTljYTEtZjI0MmJjZDdjZGEw"
            }
        },
        "id": "60a4ce03-deda-6df1-9ca1-f242bcd7cda0",
        "uniqueName": "aaronparker@cloud.stealthpuppy.com",
        "imageUrl": "https://dev.azure.com/stealthpuppyLab/_apis/GraphProfile/MemberAvatars/aad.NjBhNGNlMDMtZGVkYS03ZGYxLTljYTEtZjI0MmJjZDdjZGEw",
        "descriptor": "aad.NjBhNGNlMDMtZGVkYS03ZGYxLTljYTEtZjI0MmJjZDdjZGEw"
    },
    "drafts": [],
    "queue": {
        "_links": {
            "self": {
                "href": "https://dev.azure.com/stealthpuppyLab/_apis/build/Queues/9"
            }
        },
        "id": 9,
        "name": "Azure Pipelines",
        "url": "https://dev.azure.com/stealthpuppyLab/_apis/build/Queues/9",
        "pool": {
            "id": 9,
            "name": "Azure Pipelines",
            "isHosted": true
        }
    },
    "id": 9,
    "name": "windows11-multisession-wvd",
    "url": "https://dev.azure.com/stealthpuppyLab/43bf99ab-7b12-4015-9e5b-30c20cd7cd60/_apis/build/Definitions/9?revision=1",
    "uri": "vstfs:///Build/Definition/9",
    "path": "\\",
    "type": 2,
    "queueStatus": 0,
    "revision": 1,
    "createdDate": "2021-12-06T11:13:31.843Z",
    "project": {
        "id": "43bf99ab-7b12-4015-9e5b-30c20cd7cd60",
        "name": "Packer",
        "description": "Run Packer builds for Azure VM images",
        "url": "https://dev.azure.com/stealthpuppyLab/_apis/projects/43bf99ab-7b12-4015-9e5b-30c20cd7cd60",
        "state": 1,
        "revision": 21,
        "visibility": 2,
        "lastUpdateTime": "2020-11-17T08:08:17.170Z"
    }
}